#!/usr/bin/env node

(async () => {
    const { join } = require("path");
    const { homedir } = require("os");
    const verify = require("..");

    const projectDir = process.env.INIT_CWD || process.cwd();

    const config = loadConfig();
    const releaseConfig = loadReleaseConfig();

    const installOptions = {
        save: "--save",
        saveDev: "--save-dev"
    };

    const { dependencies = [] } = config;
    const { devDependencies = [] } = config;
    await installPackages(dependencies, installOptions.save);
    await installPackages(devDependencies, installOptions.saveDev);

    const { updateWebpack } = config;
    if (updateWebpack) {
        const options = Object.keys(updateWebpack)
            .filter(o => updateWebpack[o]);

        await verify.updateNsWebpack(options);
    }

    const { build = [], run = [] } = config;
    const buildsReport = await verifyApp(build, verify.verifyBuild, "build");
    const runsReport = await verifyApp(run, verify.verifyRun, "run");
    const report = Object.assign({}, buildsReport, runsReport);

    await verify.saveReport(report);
    console.log(`REPORT: ${JSON.stringify(report, null, 2)}`);

    process.exit(0);

    async function installPackages(packages, option) {
        for (package of packages) {
            await verify.install(package, option);
        }
    }

    async function verifyApp(configurations, verification, action) {
        const results = {};
        for (const [index, build] of configurations.entries()) {
            const keepReport = shouldKeepReport(build, config);
            const configurationName = build.name || (index + 1).toString();
            const name = action ? `${action}-${configurationName}` : configurationName;

            results[name] = await
                verification(build, releaseConfig, keepReport && name);
        }

        return results;
    }

    function shouldKeepReport(build, config) {
        return build.hasOwnProperty("keepReport") ?
            build.keepReport :
            config.keepReport;
    }

    function loadConfig() {
        const configPath = process.env.npm_config_path;
        if (!configPath) {
            console.error("You must specify configuration file path!");
            process.exit(1);
        }
        const config = loadJson(configPath);

        return config;
    }

    function loadReleaseConfig() {
        const releaseConfig = {
            android: "--release",
            ios: "--release"
        };

        const releaseConfigPath = process.env.npm_config_release_config || config.releaseConfig;
        if (releaseConfigPath) {
            const loadedConfig = loadJson(releaseConfigPath);
            const overrideDefaults = key => releaseConfig[key] = loadedConfig[key];
            Object.keys(loadedConfig).forEach(overrideDefaults)
        }

        return releaseConfig;
    }

    function loadJson(path) {
        if (path.startsWith(".")) {
            path = join(projectDir, path);
        } else if (path.startsWith("~")) {
            path = join(homedir(), path.substr(1));
        }

        const file = require(path);

        return file;
    }
})();

